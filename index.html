<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chat por Salas</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 12px }
    #rooms, #chat { display: inline-block; vertical-align: top }
    #rooms { width: 200px; margin-right: 12px }
    #chat { width: 600px }
    #messages { height: 400px; border: 1px solid #ccc; overflow-y: auto; padding: 6px }
    .system { color: #666; font-size: 0.9em }
  </style>
</head>
<body>
  <h2>Chat — Salas</h2>
  <div>
    <label>Usuário: <input id="username" /></label>
    <button id="setUsername">Set</button>
  </div>
  <div id="rooms">
    <h3>Salas</h3>
    <div>
      <input id="newRoom" placeholder="nova sala" />
      <button id="createRoom">Criar</button>
    </div>
    <ul id="roomList"></ul>
    <button id="refreshRooms">Atualizar</button>
  </div>

  <div id="chat">
    <h3 id="roomTitle">Nenhuma sala</h3>
    <div id="messages"></div>
    <div>
      <input id="msgInput" style="width:80%" />
      <button id="send">Enviar</button>
      <button id="leave">Sair da sala</button>
    </div>
  </div>

  <script>
    const ws = new WebSocket('ws://' + location.hostname + ':8765');
    let currentRoom = null;

    function append(msg, cls) {
      const d = document.createElement('div');
      if (cls) d.className = cls;
      d.textContent = msg;
      document.getElementById('messages').appendChild(d);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    ws.onopen = () => {
      append('Conectado ao servidor', 'system');
      refreshRooms();
    }
    ws.onmessage = (ev) => {
      const data = JSON.parse(ev.data);
      if (data.type === 'rooms_list') {
        const list = document.getElementById('roomList');
        list.innerHTML = '';
        data.rooms.forEach(r => {
          const li = document.createElement('li');
          const btn = document.createElement('button');
          btn.textContent = 'Entrar';
          btn.onclick = () => { ws.send(JSON.stringify({type:'join_room', room: r})); };
          li.appendChild(document.createTextNode(r + ' '));
          li.appendChild(btn);
          list.appendChild(li);
        });
      } else if (data.type === 'message') {
        append('['+data.room+'] '+data.from+': '+data.text);
      } else if (data.type === 'user_joined') {
        append(data.username + ' entrou na sala ' + data.room, 'system');
      } else if (data.type === 'user_left') {
        append(data.username + ' saiu da sala ' + data.room, 'system');
      } else if (data.type === 'joined') {
        currentRoom = data.room;
        document.getElementById('roomTitle').textContent = 'Sala: ' + currentRoom;
        document.getElementById('messages').innerHTML = '';
        append('Bem-vindo à sala ' + currentRoom, 'system');
      } else if (data.type === 'left') {
        append('Você saiu da sala ' + data.room, 'system');
        currentRoom = null;
        document.getElementById('roomTitle').textContent = 'Nenhuma sala';
        document.getElementById('messages').innerHTML = '';
      } else if (data.type === 'room_created') {
        append('Sala criada: ' + data.room, 'system');
        refreshRooms();
      } else if (data.type === 'username_set') {
        append('Username definido: ' + data.username, 'system');
      } else if (data.type === 'error') {
        append('Erro: ' + data.message, 'system');
      } else {
        append('Srv: ' + JSON.stringify(data), 'system');
      }
    }

    function refreshRooms(){ ws.send(JSON.stringify({type:'list_rooms'})); }

    document.getElementById('createRoom').onclick = () => {
      const r = document.getElementById('newRoom').value.trim();
      if (!r) return alert('nome vazio');
      ws.send(JSON.stringify({type:'create_room', room: r}));
    }

    document.getElementById('send').onclick = () => {
      const t = document.getElementById('msgInput').value;
      if (!t) return;
      ws.send(JSON.stringify({type:'message', text: t}));
      document.getElementById('msgInput').value = '';
    }

    document.getElementById('leave').onclick = () => { ws.send(JSON.stringify({type:'leave_room'})); }
    document.getElementById('refreshRooms').onclick = refreshRooms;
    document.getElementById('setUsername').onclick = () => {
      const u = document.getElementById('username').value.trim();
      if (!u) return;
      ws.send(JSON.stringify({type:'set_username', username: u}));
    }
  </script>
</body>
</html>
